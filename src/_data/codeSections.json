[
  {
    "id": "html-product-card",
    "title": "HTML Product Card with BEM",
    "description": "Semantic product card structure using BEM naming conventions and UCP-ready data attributes",
    "category": "html",
    "tags": ["bem", "semantic", "product-card", "data-attributes", "ucp"],
    "language": "html",
    "order": 1,
    "code": "<!-- Product Card Component with UCP-Ready Data Attributes -->\n<div class=\"product-card\"\n     data-product-id=\"prod-12345\"\n     data-product-sku=\"HD-CLAY-001\"\n     data-ucp-entity=\"product\">\n\n  <!-- Product Image -->\n  <div class=\"product-card__image-container\">\n    <img class=\"product-card__image\"\n         src=\"/images/american-crew-clay.jpg\"\n         alt=\"American Crew Matte Clay\">\n  </div>\n\n  <!-- Product Details -->\n  <div class=\"product-card__details\">\n    <h3 class=\"product-card__title\" data-field=\"title\">\n      American Crew Matte Clay\n    </h3>\n    \n    <p class=\"product-card__price\"\n       data-field=\"price\"\n       data-currency=\"USD\"\n       data-value=\"24.99\">\n      $24.99\n    </p>\n    \n    <p class=\"product-card__description\">\n      High hold with matte finish. Perfect for short to medium hair styles.\n    </p>\n  </div>\n\n  <!-- Product Actions -->\n  <div class=\"product-card__actions\">\n    <button class=\"product-card__button product-card__button--primary\"\n            data-action=\"add-to-cart\"\n            data-item-id=\"prod-12345\"\n            data-item-name=\"American Crew Matte Clay\"\n            data-item-brand=\"American Crew\"\n            data-item-category=\"Hair Styling\"\n            data-item-price=\"24.99\"\n            data-currency=\"USD\">\n      Add to Cart\n    </button>\n    \n    <button class=\"product-card__button product-card__button--secondary\"\n            data-action=\"view-details\"\n            data-item-id=\"prod-12345\">\n      View Details\n    </button>\n  </div>\n</div>"
  },
  {
    "id": "ucp-integration",
    "title": "UCP Integration Class",
    "description": "JavaScript class for managing Universal Commerce Protocol authentication and session state",
    "category": "javascript",
    "tags": ["ucp", "authentication", "session", "token", "middleware"],
    "language": "javascript",
    "order": 2,
    "code": "/**\n * Universal Commerce Protocol Integration\n * Manages user authentication, session state, and token handling\n */\nclass UCPIntegration {\n  constructor(config) {\n    this.apiEndpoint = config.apiEndpoint || 'https://api.ucp.example.com';\n    this.middlewareUrl = config.middlewareUrl; // Xano or n8n endpoint\n    this.token = null;\n    this.userId = null;\n    this.sessionId = null;\n    this.init();\n  }\n  \n  /**\n   * Initialize UCP session\n   */\n  async init() {\n    // Check for existing token in localStorage\n    this.token = localStorage.getItem('ucp_token');\n    \n    if (this.token) {\n      await this.validateToken();\n    } else {\n      await this.createSession();\n    }\n  }\n  \n  /**\n   * Create new UCP session\n   */\n  async createSession() {\n    try {\n      const response = await fetch(`${this.middlewareUrl}/create-session`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          timestamp: Date.now(),\n          referrer: document.referrer,\n          userAgent: navigator.userAgent\n        })\n      });\n      \n      const data = await response.json();\n      \n      this.token = data.token;\n      this.userId = data.userId;\n      this.sessionId = data.sessionId;\n      \n      // Store token\n      localStorage.setItem('ucp_token', this.token);\n      localStorage.setItem('ucp_session_id', this.sessionId);\n      \n      console.log('UCP Session Created:', this.sessionId);\n    } catch (error) {\n      console.error('UCP Session Creation Failed:', error);\n    }\n  }\n  \n  /**\n   * Validate existing token\n   */\n  async validateToken() {\n    try {\n      const response = await fetch(`${this.middlewareUrl}/validate-token`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this.token}`\n        }\n      });\n      \n      if (response.ok) {\n        const data = await response.json();\n        this.userId = data.userId;\n        this.sessionId = data.sessionId;\n        console.log('UCP Token Valid');\n      } else {\n        // Token invalid, create new session\n        await this.createSession();\n      }\n    } catch (error) {\n      console.error('UCP Token Validation Failed:', error);\n      await this.createSession();\n    }\n  }\n  \n  /**\n   * Get hashed token for analytics (privacy-safe)\n   */\n  getHashedToken() {\n    if (!this.token) return null;\n    \n    // Simple hash for demonstration\n    // In production, use proper crypto hashing\n    let hash = 0;\n    for (let i = 0; i < this.token.length; i++) {\n      const char = this.token.charCodeAt(i);\n      hash = ((hash << 5) - hash) + char;\n      hash = hash & hash;\n    }\n    return 'ucp_' + Math.abs(hash).toString(36);\n  }\n  \n  /**\n   * Update user context\n   */\n  async updateContext(contextData) {\n    try {\n      await fetch(`${this.middlewareUrl}/update-context`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${this.token}`\n        },\n        body: JSON.stringify({\n          sessionId: this.sessionId,\n          context: contextData\n        })\n      });\n    } catch (error) {\n      console.error('UCP Context Update Failed:', error);\n    }\n  }\n}\n\n// Initialize UCP\nconst ucp = new UCPIntegration({\n  middlewareUrl: 'https://your-middleware.xano.io/api:v1'\n});"
  },
  {
    "id": "ga4-event-tracker",
    "title": "GA4 Event Tracker",
    "description": "Complete GA4 ecommerce tracking with UCP integration for purchase, add to cart, and checkout events",
    "category": "javascript",
    "tags": ["ga4", "analytics", "ecommerce", "tracking", "datalayer"],
    "language": "javascript",
    "order": 3,
    "code": "/**\n * GA4 Event Tracking with UCP Integration\n * Implements Google Analytics 4 ecommerce tracking with Universal Commerce Protocol\n */\nclass GA4EventTracker {\n  constructor(ucpInstance) {\n    this.ucp = ucpInstance;\n    this.dataLayer = window.dataLayer || [];\n    window.dataLayer = this.dataLayer;\n  }\n  \n  /**\n   * Track Add to Cart Event\n   * Fires when user clicks \"Add to Cart\" button\n   */\n  trackAddToCart(element) {\n    const productCard = element.closest('.product-card');\n    \n    // Extract data from BEM-structured HTML\n    const eventData = {\n      event: 'add_to_cart',\n      \n      // UCP User Context\n      user_id: this.ucp.userId,\n      ucp_token_hash: this.ucp.getHashedToken(),\n      ucp_session_id: this.ucp.sessionId,\n      \n      // Element Context (captured by GTM)\n      element_id: element.id,\n      element_class: element.className,\n      element_label: element.textContent.trim(),\n      element_action: element.getAttribute('data-action'),\n      \n      // Product Data\n      ecommerce: {\n        currency: element.getAttribute('data-currency') || 'USD',\n        value: parseFloat(element.getAttribute('data-item-price')),\n        items: [{\n          item_id: element.getAttribute('data-item-id'),\n          item_name: element.getAttribute('data-item-name'),\n          item_brand: element.getAttribute('data-item-brand'),\n          item_category: element.getAttribute('data-item-category'),\n          price: parseFloat(element.getAttribute('data-item-price')),\n          quantity: 1\n        }]\n      },\n      \n      // UCP Entity Context\n      ucp_entity_type: productCard.getAttribute('data-ucp-entity'),\n      ucp_product_id: productCard.getAttribute('data-product-id'),\n      ucp_product_sku: productCard.getAttribute('data-product-sku')\n    };\n    \n    // Push to data layer\n    this.dataLayer.push(eventData);\n    \n    console.log('GA4 Event: add_to_cart', eventData);\n  }\n  \n  /**\n   * Track Purchase Event\n   * Fires on successful checkout completion\n   */\n  trackPurchase(orderData) {\n    const eventData = {\n      event: 'purchase',\n      \n      // UCP User Context\n      user_id: this.ucp.userId,\n      ucp_token_hash: this.ucp.getHashedToken(),\n      ucp_session_id: this.ucp.sessionId,\n      \n      // Transaction Data\n      ecommerce: {\n        transaction_id: orderData.transaction_id,\n        affiliation: orderData.affiliation || 'Online Store',\n        value: orderData.total,\n        tax: orderData.tax,\n        shipping: orderData.shipping,\n        currency: orderData.currency || 'USD',\n        coupon: orderData.coupon || '',\n        \n        // Items purchased\n        items: orderData.items.map(item => ({\n          item_id: item.product_id,\n          item_name: item.name,\n          item_brand: item.brand,\n          item_category: item.category,\n          item_variant: item.variant || '',\n          price: item.price,\n          quantity: item.quantity,\n          \n          // UCP-specific fields\n          ucp_product_id: item.ucp_product_id,\n          ucp_sku: item.sku\n        }))\n      },\n      \n      // UCP Transaction Context\n      ucp_checkout_id: orderData.ucp_checkout_id,\n      ucp_payment_method: orderData.payment_method,\n      ucp_fulfillment_method: orderData.fulfillment_method\n    };\n    \n    // Push to data layer\n    this.dataLayer.push(eventData);\n    \n    console.log('GA4 Event: purchase', eventData);\n  }\n  \n  /**\n   * Track Begin Checkout Event\n   */\n  trackBeginCheckout(cartData) {\n    const eventData = {\n      event: 'begin_checkout',\n      \n      // UCP User Context\n      user_id: this.ucp.userId,\n      ucp_token_hash: this.ucp.getHashedToken(),\n      ucp_session_id: this.ucp.sessionId,\n      \n      // Cart Data\n      ecommerce: {\n        currency: cartData.currency || 'USD',\n        value: cartData.total,\n        items: cartData.items.map(item => ({\n          item_id: item.product_id,\n          item_name: item.name,\n          item_brand: item.brand,\n          item_category: item.category,\n          price: item.price,\n          quantity: item.quantity\n        }))\n      },\n      \n      // UCP Checkout Context\n      ucp_checkout_id: cartData.checkout_id\n    };\n    \n    this.dataLayer.push(eventData);\n    console.log('GA4 Event: begin_checkout', eventData);\n  }\n}\n\n// Initialize GA4 Tracker\nconst ga4Tracker = new GA4EventTracker(ucp);"
  },
  {
    "id": "event-listeners",
    "title": "Event Listeners with BEM Selectors",
    "description": "Event delegation using stable BEM class selectors for tracking user interactions",
    "category": "javascript",
    "tags": ["event-delegation", "bem", "selectors", "click-tracking"],
    "language": "javascript",
    "order": 4,
    "code": "/**\n * Event Listeners with BEM Selectors\n * Uses event delegation and stable semantic class names\n */\n\n// Add to Cart Event Listener\ndocument.addEventListener('click', function(event) {\n  const button = event.target.closest('.product-card__button[data-action=\"add-to-cart\"]');\n  \n  if (button) {\n    event.preventDefault();\n    \n    // Visual feedback\n    button.setAttribute('data-state', 'loading');\n    button.textContent = 'Adding...';\n    \n    // Track event\n    ga4Tracker.trackAddToCart(button);\n    \n    // Simulate API call\n    setTimeout(() => {\n      button.setAttribute('data-state', 'success');\n      button.textContent = 'Added to Cart';\n      \n      // Reset after 2 seconds\n      setTimeout(() => {\n        button.removeAttribute('data-state');\n        button.textContent = 'Add to Cart';\n      }, 2000);\n    }, 500);\n  }\n});\n\n// View Details Event Listener\ndocument.addEventListener('click', function(event) {\n  const button = event.target.closest('.product-card__button[data-action=\"view-details\"]');\n  \n  if (button) {\n    event.preventDefault();\n    \n    const itemId = button.getAttribute('data-item-id');\n    \n    // Track view_item event\n    window.dataLayer.push({\n      event: 'view_item',\n      user_id: ucp.userId,\n      ucp_token_hash: ucp.getHashedToken(),\n      item_id: itemId\n    });\n    \n    // Navigate to product page\n    window.location.href = `/products/${itemId}`;\n  }\n});\n\n// Checkout Button Event Listener\ndocument.addEventListener('click', function(event) {\n  const button = event.target.closest('.checkout-button');\n  \n  if (button) {\n    event.preventDefault();\n    \n    // Get cart data\n    const cartData = getCartData();\n    \n    // Track begin_checkout\n    ga4Tracker.trackBeginCheckout(cartData);\n    \n    // Navigate to checkout\n    window.location.href = '/checkout';\n  }\n});\n\n/**\n * Helper: Get cart data from DOM or localStorage\n */\nfunction getCartData() {\n  const cartItems = JSON.parse(localStorage.getItem('cart') || '[]');\n  \n  const total = cartItems.reduce((sum, item) => {\n    return sum + (item.price * item.quantity);\n  }, 0);\n  \n  return {\n    checkout_id: 'chk_' + Date.now(),\n    currency: 'USD',\n    total: total,\n    items: cartItems\n  };\n}\n\n/**\n * Helper: Complete purchase tracking\n */\nfunction completePurchase(orderData) {\n  // Track purchase event\n  ga4Tracker.trackPurchase(orderData);\n  \n  // Send to UCP backend\n  fetch(ucp.middlewareUrl + '/complete-purchase', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${ucp.token}`\n    },\n    body: JSON.stringify({\n      sessionId: ucp.sessionId,\n      order: orderData\n    })\n  }).then(response => response.json())\n    .then(data => {\n      console.log('Purchase recorded in UCP:', data);\n    })\n    .catch(error => {\n      console.error('UCP purchase recording failed:', error);\n    });\n  \n  // Clear cart\n  localStorage.removeItem('cart');\n  \n  // Redirect to confirmation\n  window.location.href = '/order-confirmation?id=' + orderData.transaction_id;\n}"
  },
  {
    "id": "product-card-css",
    "title": "Product Card CSS with BEM",
    "description": "BEM-based styling with data attribute state management for product cards",
    "category": "css",
    "tags": ["bem", "css", "product-card", "state-management"],
    "language": "css",
    "order": 5,
    "code": "/**\n * Product Card Component Styles\n * Uses BEM naming convention for maintainability\n */\n\n/* Block: product-card */\n.product-card {\n  display: flex;\n  flex-direction: column;\n  background: #ffffff;\n  border: 1px solid #e0e0e0;\n  transition: box-shadow 0.3s ease;\n}\n\n.product-card:hover {\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);\n}\n\n/* Element: product-card__image-container */\n.product-card__image-container {\n  position: relative;\n  width: 100%;\n  padding-top: 100%; /* 1:1 aspect ratio */\n  overflow: hidden;\n  background: #f5f5f5;\n}\n\n/* Element: product-card__image */\n.product-card__image {\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  object-fit: cover;\n  transition: transform 0.3s ease;\n}\n\n.product-card:hover .product-card__image {\n  transform: scale(1.05);\n}\n\n/* Element: product-card__details */\n.product-card__details {\n  padding: 1rem;\n  flex: 1;\n}\n\n/* Element: product-card__title */\n.product-card__title {\n  font-size: 1.125rem;\n  font-weight: 600;\n  color: #1a1a1a;\n  margin: 0 0 0.5rem 0;\n  line-height: 1.4;\n}\n\n/* Element: product-card__price */\n.product-card__price {\n  font-size: 1.25rem;\n  font-weight: 700;\n  color: #d32f2f;\n  margin: 0 0 0.75rem 0;\n}\n\n/* Element: product-card__description */\n.product-card__description {\n  font-size: 0.875rem;\n  color: #666666;\n  line-height: 1.6;\n  margin: 0;\n}\n\n/* Element: product-card__actions */\n.product-card__actions {\n  padding: 1rem;\n  display: flex;\n  gap: 0.5rem;\n  border-top: 1px solid #e0e0e0;\n}\n\n/* Element: product-card__button */\n.product-card__button {\n  flex: 1;\n  padding: 0.75rem 1rem;\n  font-size: 0.875rem;\n  font-weight: 600;\n  border: none;\n  cursor: pointer;\n  transition: all 0.2s ease;\n  text-align: center;\n}\n\n/* Modifier: product-card__button--primary */\n.product-card__button--primary {\n  background: #d32f2f;\n  color: #ffffff;\n}\n\n.product-card__button--primary:hover {\n  background: #b71c1c;\n}\n\n.product-card__button--primary:active {\n  background: #8b0000;\n}\n\n/* Modifier: product-card__button--secondary */\n.product-card__button--secondary {\n  background: #ffffff;\n  color: #1a1a1a;\n  border: 1px solid #e0e0e0;\n}\n\n.product-card__button--secondary:hover {\n  background: #f5f5f5;\n}\n\n/* State: Button loading */\n.product-card__button[data-state=\"loading\"] {\n  opacity: 0.6;\n  cursor: wait;\n  pointer-events: none;\n}\n\n/* State: Button success */\n.product-card__button[data-state=\"success\"] {\n  background: #2e7d32;\n  color: #ffffff;\n}\n\n/* State: Button disabled */\n.product-card__button:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n/* Responsive adjustments */\n@media (max-width: 768px) {\n  .product-card__actions {\n    flex-direction: column;\n  }\n  \n  .product-card__button {\n    width: 100%;\n  }\n}"
  },
  {
    "id": "gtm-configuration",
    "title": "GTM Tag Configuration",
    "description": "Complete Google Tag Manager setup for GA4 events with UCP parameters",
    "category": "gtm",
    "tags": ["gtm", "ga4", "configuration", "data-layer", "variables"],
    "language": "javascript",
    "order": 6,
    "code": "/**\n * Google Tag Manager Configuration\n * \n * Tag: GA4 - Add to Cart Event\n * Type: Google Analytics: GA4 Event\n * Trigger: Custom Event = 'add_to_cart'\n */\n\n// Event Name: add_to_cart\n\n// Event Parameters:\n{\n  // User identification\n  user_id: {{DLV - user_id}},\n  \n  // UCP Context\n  ucp_token_hash: {{DLV - ucp_token_hash}},\n  ucp_session_id: {{DLV - ucp_session_id}},\n  ucp_entity_type: {{DLV - ucp_entity_type}},\n  ucp_product_id: {{DLV - ucp_product_id}},\n  ucp_product_sku: {{DLV - ucp_product_sku}},\n  \n  // Element Context\n  element_id: {{DLV - element_id}},\n  element_class: {{DLV - element_class}},\n  element_label: {{DLV - element_label}},\n  element_action: {{DLV - element_action}},\n  \n  // Ecommerce Data (automatically captured)\n  currency: {{DLV - ecommerce.currency}},\n  value: {{DLV - ecommerce.value}},\n  items: {{DLV - ecommerce.items}}\n}\n\n/**\n * Data Layer Variables (DLV) to Create:\n */\n\n// Variable: DLV - user_id\n// Type: Data Layer Variable\n// Data Layer Variable Name: user_id\n\n// Variable: DLV - ucp_token_hash\n// Type: Data Layer Variable\n// Data Layer Variable Name: ucp_token_hash\n\n// Variable: DLV - ucp_session_id\n// Type: Data Layer Variable\n// Data Layer Variable Name: ucp_session_id\n\n// Variable: DLV - element_class\n// Type: Data Layer Variable\n// Data Layer Variable Name: element_class\n\n// Variable: DLV - element_action\n// Type: Data Layer Variable\n// Data Layer Variable Name: element_action\n\n// Variable: DLV - ecommerce.items\n// Type: Data Layer Variable\n// Data Layer Variable Name: ecommerce.items\n\n/**\n * Trigger Configuration:\n */\n\n// Trigger: Custom Event - add_to_cart\n// Type: Custom Event\n// Event name: add_to_cart\n// This trigger fires on: All Custom Events\n\n/**\n * Tag: GA4 - Purchase Event\n * Type: Google Analytics: GA4 Event\n * Trigger: Custom Event = 'purchase'\n */\n\n// Event Name: purchase\n\n// Event Parameters:\n{\n  user_id: {{DLV - user_id}},\n  ucp_token_hash: {{DLV - ucp_token_hash}},\n  ucp_session_id: {{DLV - ucp_session_id}},\n  ucp_checkout_id: {{DLV - ucp_checkout_id}},\n  ucp_payment_method: {{DLV - ucp_payment_method}},\n  ucp_fulfillment_method: {{DLV - ucp_fulfillment_method}},\n  \n  // Transaction data (automatically captured from ecommerce object)\n  transaction_id: {{DLV - ecommerce.transaction_id}},\n  affiliation: {{DLV - ecommerce.affiliation}},\n  value: {{DLV - ecommerce.value}},\n  tax: {{DLV - ecommerce.tax}},\n  shipping: {{DLV - ecommerce.shipping}},\n  currency: {{DLV - ecommerce.currency}},\n  coupon: {{DLV - ecommerce.coupon}},\n  items: {{DLV - ecommerce.items}}\n}\n\n/**\n * Debug Mode:\n * Enable GA4 DebugView by adding ?debug_mode=true to URL\n * Or set debug_mode: true in dataLayer push\n */\n\nwindow.dataLayer.push({\n  event: 'add_to_cart',\n  debug_mode: true, // Enable for testing\n  // ... rest of event data\n});"
  },
  {
    "id": "complete-integration",
    "title": "Complete Integration Flow",
    "description": "Full implementation showing how all components work together from HTML to GA4",
    "category": "integration",
    "tags": ["full-stack", "integration", "workflow", "implementation"],
    "language": "javascript",
    "order": 7,
    "code": "/**\n * Complete GA4 + UCP Integration Flow\n * This example shows the full implementation from page load to event tracking\n */\n\n// Step 1: Initialize on page load\ndocument.addEventListener('DOMContentLoaded', async function() {\n  \n  // Initialize UCP Integration\n  const ucp = new UCPIntegration({\n    middlewareUrl: 'https://your-middleware.xano.io/api:v1'\n  });\n  \n  // Wait for UCP to initialize\n  await ucp.init();\n  \n  // Initialize GA4 Tracker\n  const ga4Tracker = new GA4EventTracker(ucp);\n  \n  // Step 2: Set up event listeners\n  setupEventListeners(ga4Tracker);\n  \n  // Step 3: Track page view\n  trackPageView(ucp);\n});\n\n/**\n * Set up all event listeners\n */\nfunction setupEventListeners(ga4Tracker) {\n  \n  // Add to Cart\n  document.addEventListener('click', function(event) {\n    const button = event.target.closest('.product-card__button[data-action=\"add-to-cart\"]');\n    if (button) {\n      event.preventDefault();\n      handleAddToCart(button, ga4Tracker);\n    }\n  });\n  \n  // Begin Checkout\n  document.addEventListener('click', function(event) {\n    const button = event.target.closest('.checkout-button');\n    if (button) {\n      event.preventDefault();\n      handleBeginCheckout(ga4Tracker);\n    }\n  });\n}\n\n/**\n * Handle Add to Cart action\n */\nfunction handleAddToCart(button, ga4Tracker) {\n  // Update button state\n  button.setAttribute('data-state', 'loading');\n  button.textContent = 'Adding...';\n  \n  // Track GA4 event\n  ga4Tracker.trackAddToCart(button);\n  \n  // Add to cart (API call)\n  const itemData = {\n    product_id: button.getAttribute('data-item-id'),\n    name: button.getAttribute('data-item-name'),\n    price: parseFloat(button.getAttribute('data-item-price')),\n    quantity: 1\n  };\n  \n  addToCartAPI(itemData)\n    .then(() => {\n      // Success state\n      button.setAttribute('data-state', 'success');\n      button.textContent = 'Added!';\n      \n      // Update cart count in header\n      updateCartCount();\n      \n      // Reset button after 2 seconds\n      setTimeout(() => {\n        button.removeAttribute('data-state');\n        button.textContent = 'Add to Cart';\n      }, 2000);\n    })\n    .catch(error => {\n      console.error('Add to cart failed:', error);\n      button.removeAttribute('data-state');\n      button.textContent = 'Error - Try Again';\n    });\n}\n\n/**\n * Handle Begin Checkout\n */\nfunction handleBeginCheckout(ga4Tracker) {\n  const cartData = getCartData();\n  \n  if (cartData.items.length === 0) {\n    alert('Your cart is empty');\n    return;\n  }\n  \n  // Track begin_checkout\n  ga4Tracker.trackBeginCheckout(cartData);\n  \n  // Navigate to checkout\n  window.location.href = '/checkout';\n}\n\n/**\n * Track page view\n */\nfunction trackPageView(ucp) {\n  window.dataLayer.push({\n    event: 'page_view',\n    user_id: ucp.userId,\n    ucp_token_hash: ucp.getHashedToken(),\n    ucp_session_id: ucp.sessionId,\n    page_path: window.location.pathname,\n    page_title: document.title\n  });\n}\n\n/**\n * API: Add item to cart\n */\nfunction addToCartAPI(itemData) {\n  return fetch('/api/cart/add', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json'\n    },\n    body: JSON.stringify(itemData)\n  }).then(response => {\n    if (!response.ok) throw new Error('API Error');\n    return response.json();\n  });\n}\n\n/**\n * Get cart data from localStorage\n */\nfunction getCartData() {\n  const items = JSON.parse(localStorage.getItem('cart') || '[]');\n  const total = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);\n  \n  return {\n    checkout_id: 'chk_' + Date.now(),\n    currency: 'USD',\n    total: total,\n    items: items\n  };\n}\n\n/**\n * Update cart count badge\n */\nfunction updateCartCount() {\n  const cart = JSON.parse(localStorage.getItem('cart') || '[]');\n  const count = cart.reduce((sum, item) => sum + item.quantity, 0);\n  \n  const badge = document.querySelector('.cart-badge');\n  if (badge) {\n    badge.textContent = count;\n    badge.style.display = count > 0 ? 'block' : 'none';\n  }\n}"
  },
  {
    "id": "xano-idempotent-keys",
    "title": "Xano: Idempotent Keys for AP2",
    "description": "Xano serverless function implementing idempotent keys to prevent duplicate API requests in Analytics Protocol 2",
    "category": "serverless",
    "tags": ["xano", "serverless", "idempotency", "ap2", "deduplication", "ga4"],
    "language": "javascript",
    "order": 8,
    "code": "/**\n * Xano Serverless Function: Idempotent Keys for AP2\n * Prevents duplicate GA4 Measurement Protocol events\n * \n * Use Case: Ensure purchase events are only sent once,\n * even if the client retries due to network issues\n */\n\n// Xano Function Stack Configuration\n// Endpoint: POST /api/v1/ga4/event\n// Authentication: API Key or Bearer Token\n\n/**\n * Step 1: Generate Idempotency Key (Client-side)\n */\nfunction generateIdempotencyKey(eventData) {\n  // Create deterministic key from event data\n  const keyComponents = [\n    eventData.client_id,\n    eventData.event_name,\n    eventData.transaction_id || eventData.timestamp,\n    eventData.items?.map(i => i.item_id).join('-') || ''\n  ];\n  \n  // SHA-256 hash for consistent key generation\n  return crypto.subtle.digest(\n    'SHA-256',\n    new TextEncoder().encode(keyComponents.join('|'))\n  ).then(hash => {\n    return Array.from(new Uint8Array(hash))\n      .map(b => b.toString(16).padStart(2, '0'))\n      .join('');\n  });\n}\n\n/**\n * Step 2: Xano Function - Check and Process Event\n * (Xano No-Code Logic / Custom Function)\n */\n\n// --- Xano Function Stack ---\n// 1. Get idempotency_key from request headers\n// 2. Query idempotency_cache table\n// 3. If exists and not expired -> return cached response\n// 4. If not exists -> process event, cache response\n\n// Xano Custom Function (JavaScript)\nconst xanoIdempotentHandler = async (input) => {\n  const { idempotencyKey, eventPayload, ttlMinutes = 60 } = input;\n  \n  // Check cache (Xano Database Query)\n  const cached = await xano.db.query(\n    'idempotency_cache',\n    { idempotency_key: idempotencyKey }\n  );\n  \n  if (cached && !isExpired(cached.created_at, ttlMinutes)) {\n    return {\n      status: 'duplicate',\n      message: 'Event already processed',\n      original_response: cached.response,\n      idempotency_key: idempotencyKey\n    };\n  }\n  \n  // Forward to GA4 Measurement Protocol\n  const ga4Response = await sendToGA4(eventPayload);\n  \n  // Cache the response\n  await xano.db.insert('idempotency_cache', {\n    idempotency_key: idempotencyKey,\n    event_name: eventPayload.events[0].name,\n    response: ga4Response,\n    created_at: new Date().toISOString()\n  });\n  \n  return {\n    status: 'processed',\n    response: ga4Response,\n    idempotency_key: idempotencyKey\n  };\n};\n\n/**\n * Step 3: Send to GA4 Measurement Protocol\n */\nasync function sendToGA4(payload) {\n  const GA4_ENDPOINT = 'https://www.google-analytics.com/mp/collect';\n  const MEASUREMENT_ID = process.env.GA4_MEASUREMENT_ID;\n  const API_SECRET = process.env.GA4_API_SECRET;\n  \n  const response = await fetch(\n    `${GA4_ENDPOINT}?measurement_id=${MEASUREMENT_ID}&api_secret=${API_SECRET}`,\n    {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(payload)\n    }\n  );\n  \n  return {\n    status: response.status,\n    timestamp: new Date().toISOString()\n  };\n}\n\n/**\n * Step 4: Client Usage Example\n */\nasync function sendGA4Event(eventData) {\n  const idempotencyKey = await generateIdempotencyKey(eventData);\n  \n  const response = await fetch('https://your-xano.xano.io/api/v1/ga4/event', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'X-Idempotency-Key': idempotencyKey,\n      'Authorization': 'Bearer YOUR_API_KEY'\n    },\n    body: JSON.stringify({\n      client_id: getClientId(),\n      events: [{\n        name: 'purchase',\n        params: eventData\n      }]\n    })\n  });\n  \n  return response.json();\n}\n\n// Example: Safe purchase tracking\nsendGA4Event({\n  transaction_id: 'T-12345',\n  value: 99.99,\n  currency: 'USD',\n  items: [{ item_id: 'SKU-001', item_name: 'Product', price: 99.99 }]\n});"
  },
  {
    "id": "cloudflare-edge-emea",
    "title": "Cloudflare Workers: Edge Serving for EMEA",
    "description": "Cloudflare Workers for GDPR-compliant GA4 event processing at the edge with EU data residency",
    "category": "serverless",
    "tags": ["cloudflare", "workers", "edge", "emea", "gdpr", "privacy", "ga4"],
    "language": "javascript",
    "order": 9,
    "code": "/**\n * Cloudflare Worker: Edge Serving for EMEA\n * GDPR-compliant GA4 event processing with EU data residency\n * \n * Use Case: Process analytics events at EU edge locations,\n * strip PII before forwarding, ensure data never leaves EU\n */\n\n// wrangler.toml configuration:\n// [env.production]\n// routes = [{ pattern = \"analytics.yourdomain.com/*\", zone_name = \"yourdomain.com\" }]\n// [placement]\n// mode = \"smart\" # Runs at nearest edge location\n\nexport default {\n  async fetch(request, env, ctx) {\n    const url = new URL(request.url);\n    \n    // Only handle POST requests to /collect endpoint\n    if (request.method !== 'POST' || !url.pathname.startsWith('/collect')) {\n      return new Response('Not Found', { status: 404 });\n    }\n    \n    // Detect user region from Cloudflare headers\n    const country = request.cf?.country || 'US';\n    const isEMEA = isEMEARegion(country);\n    const colo = request.cf?.colo; // Edge location code\n    \n    try {\n      const payload = await request.json();\n      \n      // EMEA-specific processing\n      if (isEMEA) {\n        // 1. Strip/hash PII for GDPR compliance\n        const sanitizedPayload = sanitizeForGDPR(payload, country);\n        \n        // 2. Add edge metadata\n        sanitizedPayload.edge_metadata = {\n          processed_at: colo,\n          region: 'EMEA',\n          country: country,\n          timestamp: Date.now()\n        };\n        \n        // 3. Route to EU GA4 endpoint (if using server-side GTM in EU)\n        const ga4Response = await forwardToGA4(sanitizedPayload, env, 'EU');\n        \n        // 4. Optional: Store in EU-based KV for audit trail\n        if (env.EMEA_AUDIT_LOG) {\n          ctx.waitUntil(\n            env.EMEA_AUDIT_LOG.put(\n              `event:${Date.now()}:${sanitizedPayload.client_id}`,\n              JSON.stringify({\n                event: sanitizedPayload.events[0].name,\n                country,\n                colo,\n                timestamp: new Date().toISOString()\n              }),\n              { expirationTtl: 86400 * 30 } // 30 days retention\n            )\n          );\n        }\n        \n        return new Response(JSON.stringify({\n          status: 'ok',\n          region: 'EMEA',\n          edge_location: colo,\n          gdpr_compliant: true\n        }), {\n          headers: {\n            'Content-Type': 'application/json',\n            'X-Edge-Location': colo,\n            'X-Data-Region': 'EU'\n          }\n        });\n      }\n      \n      // Non-EMEA: Standard processing\n      const ga4Response = await forwardToGA4(payload, env, 'US');\n      \n      return new Response(JSON.stringify({\n        status: 'ok',\n        region: 'ROW',\n        edge_location: colo\n      }), {\n        headers: { 'Content-Type': 'application/json' }\n      });\n      \n    } catch (error) {\n      return new Response(JSON.stringify({ error: error.message }), {\n        status: 500,\n        headers: { 'Content-Type': 'application/json' }\n      });\n    }\n  }\n};\n\n/**\n * Check if country is in EMEA region\n */\nfunction isEMEARegion(country) {\n  const emeaCountries = [\n    // EU Members\n    'AT', 'BE', 'BG', 'HR', 'CY', 'CZ', 'DK', 'EE', 'FI', 'FR',\n    'DE', 'GR', 'HU', 'IE', 'IT', 'LV', 'LT', 'LU', 'MT', 'NL',\n    'PL', 'PT', 'RO', 'SK', 'SI', 'ES', 'SE',\n    // EEA + UK + CH\n    'GB', 'NO', 'IS', 'LI', 'CH',\n    // Middle East & Africa (selected)\n    'AE', 'SA', 'ZA', 'EG', 'IL', 'TR'\n  ];\n  return emeaCountries.includes(country);\n}\n\n/**\n * Sanitize payload for GDPR compliance\n */\nfunction sanitizeForGDPR(payload, country) {\n  const sanitized = JSON.parse(JSON.stringify(payload));\n  \n  // Hash client_id instead of raw value\n  if (sanitized.client_id) {\n    sanitized.client_id = hashValue(sanitized.client_id);\n  }\n  \n  // Hash user_id if present\n  if (sanitized.user_id) {\n    sanitized.user_id = hashValue(sanitized.user_id);\n  }\n  \n  // Remove precise geolocation\n  if (sanitized.events) {\n    sanitized.events.forEach(event => {\n      if (event.params) {\n        delete event.params.latitude;\n        delete event.params.longitude;\n        // Keep only country-level geo\n        event.params.geo_country = country;\n      }\n    });\n  }\n  \n  // Remove IP (Cloudflare provides this)\n  delete sanitized.ip_address;\n  \n  // Add GDPR processing flag\n  sanitized.gdpr_processed = true;\n  \n  return sanitized;\n}\n\n/**\n * Hash sensitive values\n */\nfunction hashValue(value) {\n  // Simple hash for demo - use proper crypto in production\n  let hash = 0;\n  for (let i = 0; i < value.length; i++) {\n    const char = value.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  return 'gdpr_' + Math.abs(hash).toString(36);\n}\n\n/**\n * Forward to GA4 Measurement Protocol\n */\nasync function forwardToGA4(payload, env, region) {\n  const endpoint = 'https://www.google-analytics.com/mp/collect';\n  \n  return fetch(\n    `${endpoint}?measurement_id=${env.GA4_MEASUREMENT_ID}&api_secret=${env.GA4_API_SECRET}`,\n    {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(payload)\n    }\n  );\n}\n\n/**\n * Client-side usage:\n */\n// const EDGE_ENDPOINT = 'https://analytics.yourdomain.com/collect';\n// fetch(EDGE_ENDPOINT, { method: 'POST', body: JSON.stringify(eventData) });"
  },
  {
    "id": "netlify-privacy-fires",
    "title": "Netlify Functions: GA4 Privacy Fires",
    "description": "Netlify serverless functions for consent-based GA4 event firing with privacy controls",
    "category": "serverless",
    "tags": ["netlify", "serverless", "privacy", "consent", "ga4", "gdpr", "ccpa"],
    "language": "javascript",
    "order": 10,
    "code": "/**\n * Netlify Function: GA4 Privacy Fires\n * Consent-aware event processing with privacy controls\n * \n * Use Case: Fire GA4 events only when user consent is valid,\n * apply data minimization based on consent level\n */\n\n// netlify/functions/ga4-privacy-fire.js\n\nconst CONSENT_LEVELS = {\n  NONE: 0,           // No tracking\n  ESSENTIAL: 1,      // Anonymous aggregate only\n  FUNCTIONAL: 2,     // Session tracking, no user ID\n  ANALYTICS: 3,      // Full analytics with hashed IDs\n  MARKETING: 4       // Full tracking including ads\n};\n\nexports.handler = async (event, context) => {\n  // Only accept POST requests\n  if (event.httpMethod !== 'POST') {\n    return { statusCode: 405, body: 'Method Not Allowed' };\n  }\n  \n  try {\n    const payload = JSON.parse(event.body);\n    const consentString = event.headers['x-consent-status'] || 'NONE';\n    const consentLevel = CONSENT_LEVELS[consentString] || 0;\n    \n    // Get user region from headers (set by Netlify Edge)\n    const country = event.headers['x-country'] || \n                    event.headers['x-nf-client-connection-ip-country'] || 'US';\n    \n    // Determine applicable privacy law\n    const privacyLaw = getApplicablePrivacyLaw(country);\n    \n    // Check if we can fire this event\n    const eventType = payload.events?.[0]?.name || 'unknown';\n    const canFire = canFireEvent(eventType, consentLevel, privacyLaw);\n    \n    if (!canFire.allowed) {\n      return {\n        statusCode: 200,\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          status: 'blocked',\n          reason: canFire.reason,\n          consent_required: canFire.requiredLevel,\n          current_consent: consentString\n        })\n      };\n    }\n    \n    // Apply privacy transformations based on consent level\n    const transformedPayload = applyPrivacyTransforms(\n      payload,\n      consentLevel,\n      privacyLaw\n    );\n    \n    // Add privacy metadata\n    transformedPayload.events[0].params = {\n      ...transformedPayload.events[0].params,\n      consent_level: consentString,\n      privacy_law: privacyLaw,\n      data_minimized: consentLevel < CONSENT_LEVELS.MARKETING\n    };\n    \n    // Forward to GA4\n    const ga4Response = await sendToGA4(transformedPayload);\n    \n    // Log for audit (optional - use Netlify Blobs or external service)\n    await logPrivacyAudit({\n      event_type: eventType,\n      consent_level: consentString,\n      privacy_law: privacyLaw,\n      country,\n      timestamp: new Date().toISOString(),\n      allowed: true\n    });\n    \n    return {\n      statusCode: 200,\n      headers: { \n        'Content-Type': 'application/json',\n        'X-Privacy-Law': privacyLaw,\n        'X-Consent-Applied': consentString\n      },\n      body: JSON.stringify({\n        status: 'fired',\n        event: eventType,\n        consent_level: consentString,\n        privacy_law: privacyLaw,\n        transformations_applied: getTransformationList(consentLevel)\n      })\n    };\n    \n  } catch (error) {\n    console.error('Privacy fire error:', error);\n    return {\n      statusCode: 500,\n      body: JSON.stringify({ error: 'Processing failed' })\n    };\n  }\n};\n\n/**\n * Determine which privacy law applies\n */\nfunction getApplicablePrivacyLaw(country) {\n  const laws = {\n    // GDPR countries\n    'AT': 'GDPR', 'BE': 'GDPR', 'BG': 'GDPR', 'HR': 'GDPR', 'CY': 'GDPR',\n    'CZ': 'GDPR', 'DK': 'GDPR', 'EE': 'GDPR', 'FI': 'GDPR', 'FR': 'GDPR',\n    'DE': 'GDPR', 'GR': 'GDPR', 'HU': 'GDPR', 'IE': 'GDPR', 'IT': 'GDPR',\n    'LV': 'GDPR', 'LT': 'GDPR', 'LU': 'GDPR', 'MT': 'GDPR', 'NL': 'GDPR',\n    'PL': 'GDPR', 'PT': 'GDPR', 'RO': 'GDPR', 'SK': 'GDPR', 'SI': 'GDPR',\n    'ES': 'GDPR', 'SE': 'GDPR', 'GB': 'UK-GDPR',\n    // US States\n    'US-CA': 'CCPA', 'US-VA': 'VCDPA', 'US-CO': 'CPA',\n    // Other\n    'BR': 'LGPD', 'CA': 'PIPEDA'\n  };\n  return laws[country] || 'NONE';\n}\n\n/**\n * Check if event can fire based on consent\n */\nfunction canFireEvent(eventType, consentLevel, privacyLaw) {\n  // Events that require marketing consent\n  const marketingEvents = ['view_promotion', 'select_promotion', 'ad_click'];\n  \n  // Events that require analytics consent\n  const analyticsEvents = ['purchase', 'add_to_cart', 'begin_checkout', 'view_item'];\n  \n  // Essential events (can fire with minimal consent)\n  const essentialEvents = ['page_view', 'scroll', 'first_visit'];\n  \n  // GDPR/UK-GDPR requires explicit consent for non-essential\n  if (['GDPR', 'UK-GDPR'].includes(privacyLaw)) {\n    if (marketingEvents.includes(eventType) && consentLevel < CONSENT_LEVELS.MARKETING) {\n      return { allowed: false, reason: 'Marketing consent required', requiredLevel: 'MARKETING' };\n    }\n    if (analyticsEvents.includes(eventType) && consentLevel < CONSENT_LEVELS.ANALYTICS) {\n      return { allowed: false, reason: 'Analytics consent required', requiredLevel: 'ANALYTICS' };\n    }\n  }\n  \n  // CCPA allows opt-out model (can fire unless explicitly opted out)\n  if (privacyLaw === 'CCPA' && consentLevel === CONSENT_LEVELS.NONE) {\n    if (marketingEvents.includes(eventType)) {\n      return { allowed: false, reason: 'User opted out of sale', requiredLevel: 'FUNCTIONAL' };\n    }\n  }\n  \n  return { allowed: true };\n}\n\n/**\n * Apply privacy transformations based on consent\n */\nfunction applyPrivacyTransforms(payload, consentLevel, privacyLaw) {\n  const transformed = JSON.parse(JSON.stringify(payload));\n  \n  // Level 1 (Essential): Remove all identifiers\n  if (consentLevel <= CONSENT_LEVELS.ESSENTIAL) {\n    delete transformed.user_id;\n    transformed.client_id = 'anonymous';\n    if (transformed.events?.[0]?.params) {\n      delete transformed.events[0].params.user_properties;\n    }\n  }\n  \n  // Level 2 (Functional): Hash client_id, no user_id\n  else if (consentLevel === CONSENT_LEVELS.FUNCTIONAL) {\n    delete transformed.user_id;\n    if (transformed.client_id) {\n      transformed.client_id = hashValue(transformed.client_id);\n    }\n  }\n  \n  // Level 3 (Analytics): Hash all IDs\n  else if (consentLevel === CONSENT_LEVELS.ANALYTICS) {\n    if (transformed.user_id) {\n      transformed.user_id = hashValue(transformed.user_id);\n    }\n    if (transformed.client_id) {\n      transformed.client_id = hashValue(transformed.client_id);\n    }\n  }\n  \n  // Level 4 (Marketing): Full data, no transformations\n  \n  return transformed;\n}\n\n/**\n * Hash sensitive values\n */\nfunction hashValue(value) {\n  let hash = 5381;\n  for (let i = 0; i < value.length; i++) {\n    hash = ((hash << 5) + hash) + value.charCodeAt(i);\n  }\n  return 'h_' + Math.abs(hash).toString(36);\n}\n\n/**\n * Get list of transformations applied\n */\nfunction getTransformationList(consentLevel) {\n  const transforms = [];\n  if (consentLevel <= CONSENT_LEVELS.ESSENTIAL) {\n    transforms.push('anonymized_ids', 'removed_user_properties');\n  } else if (consentLevel === CONSENT_LEVELS.FUNCTIONAL) {\n    transforms.push('hashed_client_id', 'removed_user_id');\n  } else if (consentLevel === CONSENT_LEVELS.ANALYTICS) {\n    transforms.push('hashed_all_ids');\n  }\n  return transforms;\n}\n\n/**\n * Send to GA4 Measurement Protocol\n */\nasync function sendToGA4(payload) {\n  const fetch = (await import('node-fetch')).default;\n  return fetch(\n    `https://www.google-analytics.com/mp/collect?measurement_id=${process.env.GA4_MEASUREMENT_ID}&api_secret=${process.env.GA4_API_SECRET}`,\n    {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(payload)\n    }\n  );\n}\n\n/**\n * Log for privacy audit trail\n */\nasync function logPrivacyAudit(auditData) {\n  // Implement with Netlify Blobs, external DB, or logging service\n  console.log('Privacy Audit:', JSON.stringify(auditData));\n}\n\n/**\n * Client-side usage:\n */\n// fetch('/.netlify/functions/ga4-privacy-fire', {\n//   method: 'POST',\n//   headers: {\n//     'Content-Type': 'application/json',\n//     'X-Consent-Status': 'ANALYTICS' // or 'NONE', 'ESSENTIAL', 'FUNCTIONAL', 'MARKETING'\n//   },\n//   body: JSON.stringify({\n//     client_id: 'GA1.1.123456789',\n//     events: [{ name: 'purchase', params: { value: 99.99 } }]\n//   })\n// });"
  }
]
